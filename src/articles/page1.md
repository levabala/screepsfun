# Чанджлог за 22 сентября 2018

Ну что. Сейчас мы поговорим о чанджелоге за 22 сентября. Которое принесло много, по меркам этой игры, интересного.

Данное большое игровое обновление содержит много особенностей:

- Туннели

- Логи событий в комнате

- Анбуст крипов

- Другие изменения

---

### Туннели

Ранее в игре стандартные стены мешали игре и в некоторых комнатах было невозможно выживать, но теперь эту проблему можно решить при помощи туннелей.

Наконец-то. Лично я ждал долго
По сути, функционалом туннель не отличается от дороги. Скорость крипов не изменяется, единственное, это то, что крипы не смогут разойтись в разные стороны.

- Стоимость: 45.000 энергии

- Хиты (жизни): 750.000

- Уничтожение: Теряет 15.000 хитов каждые 1.000 тиков.

---

### Журнал событий комнаты

Ранее в Screeps не было API для отслеживание того, какие действия были успешно выполнены, или какие крипы сделали что-нибудь. В этом обновлении появилась новая система «Журнал событий комнаты».

Добавлен новый метод: Room.getEventLog. Он возвращает массив, который содержит элементы событий соверщенных в комнате на последнем тике:

```javascript
{
  objectId: '54bff72ab32a10f73a57d017',
  data: {
    targetId: '54bff74fb32a10f73a57d018',
    amount: 10,
    energySpent: 5
  }
},
{
  event: EVENT_TRANSFER,
  objectId: '54bff72ab32a10f73a57d017',
  data: {
    targetId: '54bff74fb32a10f73a57d018',
    resourceType: RESOURCE_ENERGY,
    amount: 200
  }
},
{
event: EVENT_EXIT,
  objectId: '54bff72ab32a10f73a57d017',
  data: {
    room: 'W18N23',
    x: 0,
    y: 28
  }
}
```

События длятся только один тик, поэтому если необходимо отслеживать более длительный период, то их необходимо хранить самостоятельно. Каждая комната имеет свои логи. Вы можете отслеживать события крипов, как здесь:

```javascript
_.filter(creep.room.getEventLog(), { objectId: creep.id });
```

Или вы можете просмотреть все враждебные действия направленные на ваших крипов или структуры:

```javascript
_.forEach(Game.rooms, room => {
  let eventLog = room.getEventLog();
  let attackEvents = _.filter(eventLog, { event: EVENT_ATTACK });
  attackEvents.forEach(event => {
    let target = Game.getObjectById(event.targetId);
    if (target && target.my) {
      console.log(event);
    }
  });
});
```

Даже если крип был убит или ушел из комнаты, событие все еще записывается и вы сможете посмотреть, что произошло.

Записывать можно не только различные войны, но также эффективность сбора ресурсов, улучшение, строительство и ремонт.

Поскольку эти массивы могут быть очень большими, они хранятся и извелкаются движком, как необработанные строки и десериализуются с помощью JSON.

Единственное что, данный метот может потреблять CPU в зависимости от количества действий в комнате (Прибавляйте к своим CPU столько же CPU сколько и тратите, только разделенное на два. Например, вы тратите 40 CPU, то прибавляйте еще 20.)

---

### StructureLab.unboostCreep

Введен новый метод StructureLab.unboostCreep. Он удаляет все бусты с крипа и сбрасывает 50% ресурсов, потраченных на бустинг (15 из 30 на каждый модуль тела). Разница между StructureSpawn.recycleCreep в том, что данный метод всегда возвращает 15 ресурсов и не зависит от крипа и продолжительности жизни.

Анбустиг требует перезарядки, равной общему времени возвращения всех компанентов.

- Штраф при перемещении убирается. Теперь, когда крип выходит из портала у него остается такое же время жизни, как и при входе.

- Новые методы Game.map.getRoomTerrain, Room.getTerrain и Room.Terrain. Метод Game.map.getTerrainAt считается устаревшим.

- Максимальная энергия возвращаемая StructureSpawn.recycleCreep ограничена в 125 очков на часть тела.

- Creep.build не блокируется уровнем контроллера, вы можете построить любую конструкцию если он уже размещен. ERR_RCL_NOT_ENOUGH удаляется из метода.

- Еще немного маленьких фиксов
